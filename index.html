<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>M5 Hysteresis Player</title>
<style>
  /* === ãƒ‡ã‚¶ã‚¤ãƒ³ï¼ˆå‰å›ã¨åŒã˜ãƒã‚ªãƒ³ãƒ”ãƒ³ã‚¯ãƒ™ãƒ¼ã‚¹ï¼‰ === */
  :root { --bg-main: #080005; --bg-panel: #1a0510; --neon-pink: #ff007f; --neon-hot: #ff1493; --text-main: #ffddee; --text-sub: #b38896; --glow-shadow: 0 0 10px var(--neon-pink); }
  * { box-sizing: border-box; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
  body { background: var(--bg-main); color: var(--text-main); font-family: sans-serif; margin: 0; padding: 0; height: 100dvh; width: 100vw; overflow: hidden; }
  
  #container { display: flex; width: 100%; height: 100%; flex-direction: column; padding: 10px; gap: 10px; }
  
  #video-area {
    background: #000; border: 2px solid var(--neon-pink); border-radius: 12px;
    box-shadow: inset 0 0 20px rgba(255,0,127,0.2);
    display: flex; justify-content: center; align-items: center; position: relative; flex: 1; min-height: 0;
  }
  video { width: 100%; height: 100%; object-fit: contain; cursor: pointer; }

  #controls {
    background: var(--bg-panel); border: 1px solid #441025; border-radius: 16px; padding: 15px;
    display: flex; flex-direction: column; gap: 10px; overflow-y: auto; flex: 0 0 auto; max-height: 45vh;
  }
  
  @media (orientation: landscape) {
    #container { flex-direction: row; padding: 0; gap: 0; }
    #video-area { flex: 1; border: none; border-radius: 0; }
    #controls { width: 320px; height: 100%; max-height: none; border-radius: 0; border-left: 2px solid var(--neon-pink); padding: 20px; }
  }

  /* UIãƒ‘ãƒ¼ãƒ„ */
  .btn-top-group { display: flex; gap: 5px; }
  .btn-base {
    flex: 1; padding: 12px 0; border-radius: 8px; font-weight: bold; text-align: center; cursor: pointer; font-size: 14px;
    border: 1px solid var(--neon-pink); background: linear-gradient(145deg, #330a1a, #1a0510); color: var(--neon-hot);
    display: flex; align-items: center; justify-content: center;
  }
  .btn-base:active { background: var(--neon-pink); color: #fff; }
  #btn-fullscreen { flex: 0 0 50px; font-size: 20px; }
  .connected-btn { background: #00b09b !important; color: #fff; pointer-events: none; border-color: #00ffaa; box-shadow: 0 0 10px #00ffaa; }
  input[type="file"] { display: none; }

  .skip-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
  .btn-skip { background: #2a0a1a; color: #eee; border: 1px solid #551430; padding: 10px; border-radius: 6px; cursor: pointer; }
  .btn-skip:active { background: var(--neon-pink); }

  select { width: 100%; padding: 10px; background: var(--bg-main); color: var(--neon-hot); border: 1px solid var(--neon-pink); border-radius: 6px; font-size: 16px; }

  /* ãƒ¡ãƒ¼ã‚¿ãƒ¼ */
  .bar-bg { width: 100%; height: 16px; background: #2a0a1a; border-radius: 8px; position: relative; border: 1px solid #441025; overflow: hidden;}
  #bar { height: 100%; width: 0%; background: linear-gradient(90deg, var(--neon-pink), #00ffff); transition: width 0.1s; }
  
  /* é–¾å€¤ã®ãƒ©ã‚¤ãƒ³ï¼ˆè¦–è¦šåŒ–ï¼‰ */
  #threshold-line {
    position: absolute; top: 0; bottom: 0; width: 2px; background: #fff; z-index: 10;
    box-shadow: 0 0 5px #fff; left: 20%; pointer-events: none;
  }

  .label-row { display: flex; justify-content: space-between; font-size: 12px; color: var(--text-sub); margin-bottom: 2px; font-weight: bold; }
  .slider-row { margin-top: 10px; }
  input[type="range"] { -webkit-appearance: none; width: 100%; height: 30px; background: transparent; margin: 0; }
  input[type="range"]::-webkit-slider-runnable-track { width: 100%; height: 6px; background: #441025; border-radius: 3px; }
  input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: var(--neon-pink); margin-top: -7px; border: 2px solid #fff; box-shadow: 0 0 5px var(--neon-pink); }
</style>
</head>
<body>

<div id="container">
  <div id="video-area">
    <video id="v" playsinline webkit-playsinline loop onclick="toggleNativeControls()"></video>
  </div>

  <div id="controls">
    <div class="btn-top-group">
      <button id="btn-fullscreen" class="btn-base" onclick="toggleFullScreen()">â›¶</button>
      <div id="ble-connect" class="btn-base" onclick="connectBLE()">ğŸ“¡ CONNECT</div>
      <label class="btn-file btn-base">ğŸ“‚ å‹•ç”»<input type="file" id="file-input" accept="video/*"></label>
    </div>

    <div style="margin-top:10px;">
      <select id="mode">
        <option value="motion">ğŸƒ Motion (å‹•ãã¨å†ç”Ÿ)</option>
        <option value="reverse">ğŸ§˜ Reverse (æ­¢ã¾ã‚‹ã¨å†ç”Ÿ)</option>
        <option value="none">ğŸ›‘ Monitor Only</option>
      </select>
    </div>

    <div>
      <div class="label-row"><span>Motion Level</span></div>
      <div class="bar-bg">
        <div id="bar"></div>
        <div id="threshold-line"></div>
      </div>
    </div>

    <div class="skip-grid" style="margin-top:10px;">
      <button class="btn-skip" onclick="skip(-60)">-1m</button>
      <button class="btn-skip" onclick="skip(-10)">-10s</button>
      <button class="btn-skip" onclick="skip(10)">+10s</button>
      <button class="btn-skip" onclick="skip(60)">+1m</button>
      <button class="btn-skip" onclick="skip(-300)">-5m</button>
      <button class="btn-skip" onclick="skip(300)">+5m</button>
    </div>

    <div class="slider-row">
      <div class="label-row">
        <span>é–‹å§‹é–¾å€¤ (Noise Cut)</span>
        <span id="t-val">20%</span>
      </div>
      <input type="range" id="thresh" min="5" max="80" step="1" value="20" oninput="updateLine()">
    </div>

    <div class="slider-row">
      <div class="label-row"><span>æ„Ÿåº¦ (Sensitivity)</span><span id="s-val">1.0</span></div>
      <input type="range" id="sens" min="0.1" max="5.0" step="0.1" value="1.0">
    </div>
    
    <div class="slider-row">
      <div class="label-row"><span>ä½™éŸ» (Decay)</span><span id="d-val">0.95</span></div>
      <input type="range" id="decay" min="0.80" max="0.99" step="0.01" value="0.95">
    </div>
  </div>
</div>

<script>
  // UIå‡¦ç†
  const video = document.getElementById('v');
  function toggleFullScreen() {
    const doc = document.documentElement;
    if (!document.fullscreenElement && !document.webkitFullscreenElement) {
      if(doc.requestFullscreen) doc.requestFullscreen();
      else if(doc.webkitRequestFullscreen) doc.webkitRequestFullscreen();
    } else {
      if(document.exitFullscreen) document.exitFullscreen();
      else if(document.webkitExitFullscreen) document.webkitExitFullscreen();
    }
  }
  function toggleNativeControls() {
    if(video.hasAttribute("controls")) video.removeAttribute("controls");
    else video.setAttribute("controls", "controls");
  }

  // BLEæ¥ç¶š
  const SERVICE_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
  const CHARACTERISTIC_UUID = "beb5483e-36e1-4688-b7f5-ea07361b26a8";
  const btnConnect = document.getElementById('ble-connect');
  let bluetoothDevice;

  async function connectBLE() {
    try {
      btnConnect.innerText = "ğŸ”...";
      bluetoothDevice = await navigator.bluetooth.requestDevice({
        filters: [{ name: 'M5-AV-Controller' }],
        optionalServices: [SERVICE_UUID]
      });
      const server = await bluetoothDevice.gatt.connect();
      const service = await server.getPrimaryService(SERVICE_UUID);
      const characteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);
      await characteristic.startNotifications();
      characteristic.addEventListener('characteristicvaluechanged', handleData);
      btnConnect.innerText = "âœ… OK";
      btnConnect.classList.add('connected-btn');
      toggleFullScreen();
      bluetoothDevice.addEventListener('gattserverdisconnected', () => {
        btnConnect.innerText = "âŒ åˆ‡æ–­"; btnConnect.classList.remove('connected-btn');
      });
    } catch (e) { console.log(e); btnConnect.innerText = "å¤±æ•—"; }
  }

  // === åˆ¶å¾¡ãƒ­ã‚¸ãƒƒã‚¯ (Hysteresis) ===
  const bar = document.getElementById('bar');
  const threshRange = document.getElementById('thresh'); // ãƒã‚¤ã‚ºã‚«ãƒƒãƒˆ
  const sensRange = document.getElementById('sens');     // æ„Ÿåº¦
  const decayRange = document.getElementById('decay');   // ä½™éŸ»
  
  // è¦–è¦šçš„ãªãƒ©ã‚¤ãƒ³ã®ä½ç½®ã‚’æ›´æ–°
  function updateLine() {
    document.getElementById('threshold-line').style.left = threshRange.value + "%";
    document.getElementById('t-val').innerText = threshRange.value + "%";
  }
  updateLine(); // åˆæœŸå®Ÿè¡Œ

  let smoothVal = 0;
  let isPlaying = false; // ç¾åœ¨å†ç”Ÿä¸­ã‹ã©ã†ã‹ã®çŠ¶æ…‹ä¿æŒ

  function handleData(event) {
    const value = new TextDecoder().decode(event.target.value);
    let motion = parseFloat(value);
    if(motion < 0.05) motion = 0;

    const decay = parseFloat(decayRange.value);
    const sens = parseFloat(sensRange.value);

    // ã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°è¨ˆç®—
    smoothVal = (smoothVal * decay) + (motion * (1.0 - decay) * sens * 10);
    
    // è¡¨ç¤ºç”¨ï¼ˆ0-100%ï¼‰
    let displayVal = Math.min(smoothVal * 20, 100);
    bar.style.width = displayVal + "%";

    // æ•°å€¤æ›´æ–°
    document.getElementById('s-val').innerText = sens;
    document.getElementById('d-val').innerText = decay;

    // å‹•ç”»ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«å®Ÿè¡Œ
    applyControl(displayVal);
  }

  function applyControl(val) {
    const mode = document.getElementById('mode').value;
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šã®é–¾å€¤ (0~100)
    const onThreshold = parseFloat(threshRange.value);
    // OFFã«ãªã‚‹é–¾å€¤ã¯ã€ONã‚ˆã‚Šå°‘ã—ä½ãè¨­å®šã™ã‚‹ï¼ˆã“ã‚ŒãŒã€Œç²˜ã‚Šã€ã«ãªã‚‹ï¼‰
    // ä¾‹: é–‹å§‹ãŒ30%ãªã‚‰ã€çµ‚äº†ã¯15%ã¾ã§ä¸‹ãŒã‚‰ãªã„ã¨æ­¢ã¾ã‚‰ãªã„
    const offThreshold = onThreshold * 0.5; 

    if (mode === 'motion') {
      if (!isPlaying) {
        // æ­¢ã¾ã£ã¦ã„ã‚‹æ™‚ã¯ã€é«˜ã„å£(Start)ã‚’è¶…ãˆãªã„ã¨å‹•ãå‡ºã•ãªã„
        if (val > onThreshold) {
          video.play();
          isPlaying = true;
        }
      } else {
        // å‹•ã„ã¦ã„ã‚‹æ™‚ã¯ã€ä½ã„å£(Stop)ã‚’ä¸‹å›ã‚‹ã¾ã§æ­¢ã¾ã‚‰ãªã„
        if (val < offThreshold) {
          video.pause();
          isPlaying = false;
        }
      }
    } 
    else if (mode === 'reverse') {
      // ãƒªãƒãƒ¼ã‚¹ï¼ˆæ­¢ã¾ã‚‹ã¨å†ç”Ÿï¼‰ã®å ´åˆã®ãƒ­ã‚¸ãƒƒã‚¯
      // å‹•ã‹ã—ã¦ã„ãªã„(valãŒä½ã„)ã¨å†ç”Ÿ
      if (!isPlaying) {
        if (val < offThreshold) {
          video.play();
          isPlaying = true;
        }
      } else {
        // å‹•ã‹ã—å§‹ã‚ã‚‹(Start)ã¨åœæ­¢
        if (val > onThreshold) {
          video.pause();
          isPlaying = false;
        }
      }
    }
  }

  document.getElementById('file-input').addEventListener('change', function(e){
    if(e.target.files[0]) video.src = URL.createObjectURL(e.target.files[0]);
  });
  function skip(sec) { if(video.src) video.currentTime += sec; }
</script>
</body>
</html>
