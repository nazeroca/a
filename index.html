<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>M5 BLE AV Player</title>
<style>
  body { background-color: #000; color: #eee; font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
  #container { flex: 1; display: flex; flex-direction: column; padding: 10px; gap: 8px; }
  
  /* BLEæ¥ç¶šãƒœã‚¿ãƒ³ */
  #ble-connect {
    background: #ff5722; color: white; padding: 15px; 
    border-radius: 8px; font-weight: bold; text-align: center; 
    cursor: pointer; margin-bottom: 5px;
  }
  .connected-btn { background: #4caf50 !important; pointer-events: none; }

  #video-area { flex: 2; background: #111; border: 1px solid #333; border-radius: 8px; position: relative; overflow: hidden; display: flex; justify-content: center; align-items: center;}
  video { width: 100%; height: 100%; object-fit: contain; }
  
  #controls { flex: 1.5; background: #1a1a1a; border-radius: 12px; padding: 10px; display: flex; flex-direction: column; gap: 8px; overflow-y: auto; }
  
  .btn-file { background: #007bff; color: white; padding: 10px; border-radius: 8px; text-align: center; font-weight: bold; display: block; cursor: pointer; }
  input[type="file"] { display: none; }
  
  .skip-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
  .btn-skip { background: #333; color: #fff; border: 1px solid #555; border-radius: 6px; padding: 10px 0; cursor: pointer; }
  .btn-skip:active { background: #555; }
  
  select, input[type="range"] { width: 100%; padding: 8px; background: #333; color: white; border: none; border-radius: 5px; box-sizing: border-box; }
  
  .bar-bg { width: 100%; height: 10px; background: #333; border-radius: 5px; overflow: hidden; margin-top: 5px; }
  #bar { height: 100%; width: 0%; background: linear-gradient(90deg, #0f0, #ff0, #f00); transition: width 0.1s; }
  
  .row { display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; }
</style>
</head>
<body>

<div id="container">
  <div id="ble-connect" onclick="connectBLE()">ğŸ“¡ CONNECT M5 (æŠ¼ã—ã¦ãƒšã‚¢ãƒªãƒ³ã‚°)</div>

  <label class="btn-file">ğŸ“‚ å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ<input type="file" id="file-input" accept="video/*"></label>

  <div id="video-area">
    <video id="v" playsinline webkit-playsinline controls loop></video>
  </div>

  <div id="controls">
    <div class="skip-grid">
      <button class="btn-skip" onclick="skip(-300)">-5m</button>
      <button class="btn-skip" onclick="skip(-60)">-1m</button>
      <button class="btn-skip" onclick="skip(-10)">-10s</button>
      <button class="btn-skip" onclick="skip(300)">+5m</button>
      <button class="btn-skip" onclick="skip(60)">+1m</button>
      <button class="btn-skip" onclick="skip(10)">+10s</button>
    </div>

    <div style="margin-top:5px;">
      <select id="mode">
        <option value="motion">ğŸƒ Motion Play (å‹•ãã¨å†ç”Ÿ)</option>
        <option value="reverse">ğŸ§˜ Reverse Gate (æ­¢ã¾ã‚‹ã¨å†ç”Ÿ)</option>
        <option value="none">ğŸ›‘ Monitor Only</option>
      </select>
    </div>

    <div><div class="bar-bg"><div id="bar"></div></div></div>

    <div style="border-top:1px solid #333; padding-top:5px;">
      <div class="row"><small>æ„Ÿåº¦</small><small id="s-val">2.0</small></div>
      <input type="range" id="sens" min="0.5" max="5.0" step="0.1" value="2.0">
      
      <div class="row"><small>æ¸›è¡°</small><small id="d-val">0.9</small></div>
      <input type="range" id="decay" min="0.5" max="0.99" step="0.01" value="0.9">
    </div>
  </div>
</div>

<script>
  // BLEè¨­å®š
  const SERVICE_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
  const CHARACTERISTIC_UUID = "beb5483e-36e1-4688-b7f5-ea07361b26a8";
  
  let bluetoothDevice;
  let characteristic;
  
  const video = document.getElementById('v');
  const bar = document.getElementById('bar');
  const btnConnect = document.getElementById('ble-connect');
  
  // æ¥ç¶šå‡¦ç†
  async function connectBLE() {
    try {
      btnConnect.innerText = "Searching...";
      bluetoothDevice = await navigator.bluetooth.requestDevice({
        filters: [{ name: 'M5-AV-Controller' }],
        optionalServices: [SERVICE_UUID]
      });

      const server = await bluetoothDevice.gatt.connect();
      const service = await server.getPrimaryService(SERVICE_UUID);
      characteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);

      await characteristic.startNotifications();
      characteristic.addEventListener('characteristicvaluechanged', handleData);
      
      btnConnect.innerText = "âœ… CONNECTED";
      btnConnect.classList.add('connected-btn');
      
      bluetoothDevice.addEventListener('gattserverdisconnected', () => {
        btnConnect.innerText = "âŒ Disconnected (Tap to Retry)";
        btnConnect.classList.remove('connected-btn');
      });

    } catch (error) {
      console.log(error);
      btnConnect.innerText = "Connection Failed / Cancelled";
    }
  }

  // ãƒ‡ãƒ¼ã‚¿å—ä¿¡å‡¦ç†
  let smoothVal = 0;
  
  function handleData(event) {
    const value = new TextDecoder().decode(event.target.value);
    const rawG = parseFloat(value);
    
    // ä»¥å‰ã®ãƒ­ã‚¸ãƒƒã‚¯ã¨åŒã˜
    let motion = Math.abs(rawG - 1.0);
    if(motion < 0.15) motion = 0; 

    const decay = parseFloat(document.getElementById('decay').value);
    const sens = parseFloat(document.getElementById('sens').value);
    smoothVal = (smoothVal * decay) + (motion * (1.0 - decay) * sens * 10);

    let per = Math.min(smoothVal * 20, 100);
    bar.style.width = per + "%";

    controlVideo(smoothVal);
    
    document.getElementById('s-val').innerText = sens;
    document.getElementById('d-val').innerText = decay;
  }
  
  // å‹•ç”»åˆ¶å¾¡ï¼ˆä»¥å‰ã¨åŒã˜ï¼‰
  const modeSel = document.getElementById('mode');
  function controlVideo(val) {
    const mode = modeSel.value;
    const threshold = 0.5; 
    if (mode === 'motion') {
      if (val > threshold) { if(video.paused) video.play(); } 
      else { if(!video.paused) video.pause(); }
    } else if (mode === 'reverse') {
      if (val < threshold) { if(video.paused) video.play(); } 
      else { if(!video.paused) video.pause(); }
    }
  }

  // ãƒ•ã‚¡ã‚¤ãƒ«èª­è¾¼ãƒ»ã‚¹ã‚­ãƒƒãƒ—
  document.getElementById('file-input').addEventListener('change', function(e){
    if(e.target.files[0]) video.src = URL.createObjectURL(e.target.files[0]);
  });
  function skip(sec) { if(video.src) video.currentTime += sec; }
</script>
</body>
</html>
