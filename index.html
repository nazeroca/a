<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>M5 Landscape Player</title>
<style>
  /* å…¨ä½“è¨­å®š */
  * { box-sizing: border-box; touch-action: manipulation; }
  body {
    background-color: #000; color: #eee; font-family: sans-serif;
    margin: 0; padding: 0;
    height: 100dvh; width: 100vw;
    overflow: hidden;
  }

  /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ */
  #container {
    display: flex;
    width: 100%; height: 100%;
    /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆç¸¦ç”»é¢ï¼‰ã¯ç¸¦ä¸¦ã³ */
    flex-direction: column; 
    padding: 10px; gap: 10px;
  }

  /* å‹•ç”»ã‚¨ãƒªã‚¢ */
  #video-area {
    background: #000;
    border: 1px solid #333; border-radius: 8px;
    display: flex; justify-content: center; align-items: center;
    position: relative;
    /* ç¸¦ç”»é¢æ™‚ã¯å‹•ç”»ã‚¨ãƒªã‚¢ã‚’å„ªå…ˆçš„ã«ç¢ºä¿ã—ã¤ã¤ã€ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼åˆ†ã‚‚æ®‹ã™ */
    flex: 1; 
    min-height: 0;
  }
  video { width: 100%; height: 100%; object-fit: contain; }

  /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚¨ãƒªã‚¢ */
  #controls {
    background: #1a1a1a;
    border-radius: 12px;
    padding: 10px;
    display: flex; flex-direction: column; gap: 10px;
    overflow-y: auto; /* æº¢ã‚ŒãŸã‚‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
    /* ç¸¦ç”»é¢æ™‚ã®é«˜ã•ç¢ºä¿ */
    flex: 0 0 auto;
    max-height: 40vh; 
  }

  /* ======== æ¨ªç”»é¢ï¼ˆãƒ©ãƒ³ãƒ‰ã‚¹ã‚±ãƒ¼ãƒ—ï¼‰ç”¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ ======== */
  @media (orientation: landscape) {
    #container {
      flex-direction: row; /* æ¨ªä¸¦ã³ã«ã™ã‚‹ */
      padding: 0; gap: 0;
    }

    #video-area {
      flex: 1; /* æ®‹ã‚Šã®ã‚¹ãƒšãƒ¼ã‚¹å…¨éƒ¨å‹•ç”» */
      border-radius: 0; border: none;
    }

    #controls {
      width: 300px; /* å³å´ã®å›ºå®šå¹… */
      height: 100%;
      max-height: none;
      border-radius: 0;
      border-left: 1px solid #333;
      padding: 15px;
    }
  }
  /* ==================================================== */

  /* ãƒœã‚¿ãƒ³ãƒ»UIãƒ‡ã‚¶ã‚¤ãƒ³ */
  .btn-top-group { display: flex; gap: 5px; }
  
  #ble-connect {
    flex: 1; background: #ff5722; color: white; padding: 12px;
    border-radius: 6px; font-weight: bold; text-align: center; cursor: pointer;
    font-size: 14px; display: flex; align-items: center; justify-content: center;
  }
  .connected-btn { background: #4caf50 !important; pointer-events: none; }

  .btn-file {
    flex: 1; background: #007bff; color: white; padding: 12px;
    border-radius: 6px; font-weight: bold; text-align: center; cursor: pointer;
    font-size: 14px; overflow: hidden; white-space: nowrap;
  }
  input[type="file"] { display: none; }

  /* ã‚¹ã‚­ãƒƒãƒ—ãƒœã‚¿ãƒ³ï¼ˆã‚°ãƒªãƒƒãƒ‰ï¼‰ */
  .skip-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
  .btn-skip {
    background: #333; color: #fff; border: 1px solid #555; border-radius: 4px;
    padding: 12px 0; font-size: 14px; cursor: pointer;
  }
  .btn-skip:active { background: #555; }

  /* ãƒ¡ãƒ¼ã‚¿ãƒ¼ */
  .bar-bg { width: 100%; height: 10px; background: #333; border-radius: 5px; overflow: hidden; margin-top: 5px; }
  #bar { height: 100%; width: 0%; background: linear-gradient(90deg, #0f0, #ff0, #f00); transition: width 0.1s; }

  /* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ç­‰ */
  select { width: 100%; padding: 10px; background: #333; color: white; border: none; border-radius: 5px; margin-bottom: 5px; }
  .slider-row { margin-top: 10px; }
  .label-row { display: flex; justify-content: space-between; font-size: 12px; color: #aaa; margin-bottom: 2px; }
  input[type="range"] { width: 100%; margin: 0; height: 30px; }

</style>
</head>
<body>

<div id="container">
  <div id="video-area">
    <video id="v" playsinline webkit-playsinline controls loop></video>
  </div>

  <div id="controls">
    
    <div class="btn-top-group">
      <div id="ble-connect" onclick="connectBLE()">ğŸ“¡ CONNECT</div>
      <label class="btn-file">ğŸ“‚ å‹•ç”»é¸æŠ<input type="file" id="file-input" accept="video/*"></label>
    </div>

    <div style="margin-top:10px;">
      <select id="mode">
        <option value="motion">ğŸƒ Motion (å‹•ãã¨å†ç”Ÿ)</option>
        <option value="reverse">ğŸ§˜ Reverse (æ­¢ã¾ã‚‹ã¨å†ç”Ÿ)</option>
        <option value="none">ğŸ›‘ Monitor Only</option>
      </select>
    </div>

    <div>
      <div class="label-row"><span>Motion Level</span></div>
      <div class="bar-bg"><div id="bar"></div></div>
    </div>

    <div class="skip-grid" style="margin-top:10px;">
      <button class="btn-skip" onclick="skip(-60)">-1m</button>
      <button class="btn-skip" onclick="skip(-10)">-10s</button>
      <button class="btn-skip" onclick="skip(10)">+10s</button>
      <button class="btn-skip" onclick="skip(60)">+1m</button>
      <button class="btn-skip" onclick="skip(-300)">-5m</button>
      <button class="btn-skip" onclick="skip(300)">+5m</button>
    </div>

    <div class="slider-row">
      <div class="label-row"><span>æ„Ÿåº¦ (Sensitivity)</span><span id="s-val">2.0</span></div>
      <input type="range" id="sens" min="0.5" max="5.0" step="0.1" value="2.0">
    </div>

    <div class="slider-row">
      <div class="label-row"><span>ä½™éŸ» (Decay)</span><span id="d-val">0.9</span></div>
      <input type="range" id="decay" min="0.5" max="0.99" step="0.01" value="0.9">
    </div>

  </div>
</div>

<script>
  // === BLE & System ===
  const SERVICE_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
  const CHARACTERISTIC_UUID = "beb5483e-36e1-4688-b7f5-ea07361b26a8";
  
  const btnConnect = document.getElementById('ble-connect');
  let bluetoothDevice;

  // å…¨ç”»é¢åŒ–é–¢æ•°
  function goFullScreen() {
    const doc = document.documentElement;
    if (doc.requestFullscreen) { doc.requestFullscreen().catch(e=>{}); }
    else if (doc.webkitRequestFullscreen) { doc.webkitRequestFullscreen(); }
  }

  async function connectBLE() {
    try {
      btnConnect.innerText = "ğŸ”...";
      
      // 1. ãƒšã‚¢ãƒªãƒ³ã‚°ï¼ˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤ºï¼‰
      bluetoothDevice = await navigator.bluetooth.requestDevice({
        filters: [{ name: 'M5-AV-Controller' }],
        optionalServices: [SERVICE_UUID]
      });

      const server = await bluetoothDevice.gatt.connect();
      const service = await server.getPrimaryService(SERVICE_UUID);
      const characteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);

      await characteristic.startNotifications();
      characteristic.addEventListener('characteristicvaluechanged', handleData);
      
      // 2. æˆåŠŸã—ãŸã‚‰å…¨ç”»é¢åŒ–
      btnConnect.innerText = "âœ… OK";
      btnConnect.classList.add('connected-btn');
      
      setTimeout(goFullScreen, 500); // å°‘ã—å¾…ã£ã¦ã‹ã‚‰å…¨ç”»é¢ã¸

      bluetoothDevice.addEventListener('gattserverdisconnected', () => {
        btnConnect.innerText = "âŒ åˆ‡æ–­";
        btnConnect.classList.remove('connected-btn');
      });

    } catch (error) {
      console.log(error);
      btnConnect.innerText = "å¤±æ•— (å†è©¦è¡Œ)";
    }
  }

  // === Player Logic ===
  const video = document.getElementById('v');
  const bar = document.getElementById('bar');
  const modeSel = document.getElementById('mode');
  const sensRange = document.getElementById('sens');
  const decayRange = document.getElementById('decay');
  let smoothVal = 0;

  function handleData(event) {
    const value = new TextDecoder().decode(event.target.value);
    const rawG = parseFloat(value);
    let motion = Math.abs(rawG - 1.0);
    if(motion < 0.15) motion = 0; 

    const decay = parseFloat(decayRange.value);
    const sens = parseFloat(sensRange.value);
    smoothVal = (smoothVal * decay) + (motion * (1.0 - decay) * sens * 10);

    let per = Math.min(smoothVal * 20, 100);
    bar.style.width = per + "%";

    controlVideo(smoothVal);
    
    document.getElementById('s-val').innerText = sens;
    document.getElementById('d-val').innerText = decay;
  }

  function controlVideo(val) {
    const mode = modeSel.value;
    const threshold = 0.5;
    if (mode === 'motion') {
      if (val > threshold) { if(video.paused) video.play(); } 
      else { if(!video.paused) video.pause(); }
    } else if (mode === 'reverse') {
      if (val < threshold) { if(video.paused) video.play(); } 
      else { if(!video.paused) video.pause(); }
    }
  }

  document.getElementById('file-input').addEventListener('change', function(e){
    if(e.target.files[0]) video.src = URL.createObjectURL(e.target.files[0]);
  });
  function skip(sec) { if(video.src) video.currentTime += sec; }
</script>
</body>
</html>
