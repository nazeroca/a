<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>M5 TimeStop Player</title>
<style>
  /* === ãƒ‡ã‚¶ã‚¤ãƒ³ï¼ˆãƒã‚ªãƒ³ãƒ”ãƒ³ã‚¯ãƒ™ãƒ¼ã‚¹ï¼‰ === */
  :root { --bg-main: #080005; --bg-panel: #1a0510; --neon-pink: #ff007f; --neon-hot: #ff1493; --text-main: #ffddee; --text-sub: #b38896; --glow-shadow: 0 0 10px var(--neon-pink); }
  * { box-sizing: border-box; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
  body { background: var(--bg-main); color: var(--text-main); font-family: sans-serif; margin: 0; padding: 0; height: 100dvh; width: 100vw; overflow: hidden; }
  
  #container { display: flex; width: 100%; height: 100%; flex-direction: column; padding: 10px; gap: 10px; }
  
  #video-area {
    background: #000; border: 2px solid var(--neon-pink); border-radius: 12px;
    box-shadow: inset 0 0 20px rgba(255,0,127,0.2);
    display: flex; justify-content: center; align-items: center; position: relative; flex: 1; min-height: 0;
  }
  
  /* â–¼â–¼â–¼ ã“ã“ãŒé‡è¦ï¼šCSSã§å¼·åˆ¶çš„ã«ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’æ¶ˆã™é­”æ³• â–¼â–¼â–¼ */
  video { width: 100%; height: 100%; object-fit: contain; cursor: pointer; }
  
  /* Chromeã®å†…éƒ¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’éè¡¨ç¤ºã«ã™ã‚‹ */
  video::-webkit-media-controls { display: none !important; }
  video::-webkit-media-controls-play-button { display: none !important; }
  video::-webkit-media-controls-start-playback-button { display: none !important; }
  video::-webkit-media-controls-panel { display: none !important; }

  #controls {
    background: var(--bg-panel); border: 1px solid #441025; border-radius: 16px; padding: 15px;
    display: flex; flex-direction: column; gap: 10px; overflow-y: auto; flex: 0 0 auto; max-height: 45vh;
  }
  
  @media (orientation: landscape) {
    #container { flex-direction: row; padding: 0; gap: 0; }
    #video-area { flex: 1; border: none; border-radius: 0; }
    #controls { width: 320px; height: 100%; max-height: none; border-radius: 0; border-left: 2px solid var(--neon-pink); padding: 20px; }
  }

  /* UIãƒ‘ãƒ¼ãƒ„ */
  .btn-top-group { display: flex; gap: 5px; }
  .btn-base {
    flex: 1; padding: 12px 0; border-radius: 8px; font-weight: bold; text-align: center; cursor: pointer; font-size: 14px;
    border: 1px solid var(--neon-pink); background: linear-gradient(145deg, #330a1a, #1a0510); color: var(--neon-hot);
    display: flex; align-items: center; justify-content: center;
  }
  .btn-base:active { background: var(--neon-pink); color: #fff; }
  #btn-fullscreen { flex: 0 0 50px; font-size: 20px; }
  .connected-btn { background: #00b09b !important; color: #fff; pointer-events: none; border-color: #00ffaa; box-shadow: 0 0 10px #00ffaa; }
  input[type="file"] { display: none; }

  .skip-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
  .btn-skip { background: #2a0a1a; color: #eee; border: 1px solid #551430; padding: 10px; border-radius: 6px; cursor: pointer; }
  .btn-skip:active { background: var(--neon-pink); }

  select { width: 100%; padding: 10px; background: var(--bg-main); color: var(--neon-hot); border: 1px solid var(--neon-pink); border-radius: 6px; font-size: 16px; }

  .bar-bg { width: 100%; height: 16px; background: #2a0a1a; border-radius: 8px; position: relative; border: 1px solid #441025; overflow: hidden;}
  #bar { height: 100%; width: 0%; background: linear-gradient(90deg, var(--neon-pink), #00ffff); transition: width 0.1s; }
  
  #threshold-line {
    position: absolute; top: 0; bottom: 0; width: 2px; background: #fff; z-index: 10;
    box-shadow: 0 0 5px #fff; left: 20%; pointer-events: none;
  }

  .label-row { display: flex; justify-content: space-between; font-size: 12px; color: var(--text-sub); margin-bottom: 2px; font-weight: bold; }
  .slider-row { margin-top: 10px; }
  input[type="range"] { -webkit-appearance: none; width: 100%; height: 30px; background: transparent; margin: 0; }
  input[type="range"]::-webkit-slider-runnable-track { width: 100%; height: 6px; background: #441025; border-radius: 3px; }
  input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: var(--neon-pink); margin-top: -7px; border: 2px solid #fff; box-shadow: 0 0 5px var(--neon-pink); }
</style>
</head>
<body>

<div id="container">
  <div id="video-area">
    <video id="v" playsinline webkit-playsinline loop onclick="forcePlay()"></video>
  </div>

  <div id="controls">
    <div class="btn-top-group">
      <button id="btn-fullscreen" class="btn-base" onclick="toggleFullScreen()">â›¶</button>
      <div id="ble-connect" class="btn-base" onclick="connectBLE()">ğŸ“¡ CONNECT</div>
      <label class="btn-file btn-base">ğŸ“‚ å‹•ç”»<input type="file" id="file-input" accept="video/*"></label>
    </div>

    <div style="margin-top:10px;">
      <select id="mode">
        <option value="motion">ğŸƒ Motion (å‹•ãã¨å†ç”Ÿ)</option>
        <option value="reverse">ğŸ§˜ Reverse (æ­¢ã¾ã‚‹ã¨å†ç”Ÿ)</option>
        <option value="none">ğŸ›‘ Monitor Only</option>
      </select>
    </div>

    <div>
      <div class="label-row"><span>Motion Level</span></div>
      <div class="bar-bg">
        <div id="bar"></div>
        <div id="threshold-line"></div>
      </div>
    </div>

    <div class="skip-grid" style="margin-top:10px;">
      <button class="btn-skip" onclick="skip(-60)">-1m</button>
      <button class="btn-skip" onclick="skip(-10)">-10s</button>
      <button class="btn-skip" onclick="skip(10)">+10s</button>
      <button class="btn-skip" onclick="skip(60)">+1m</button>
      <button class="btn-skip" onclick="skip(-300)">-5m</button>
      <button class="btn-skip" onclick="skip(300)">+5m</button>
    </div>

    <div class="slider-row">
      <div class="label-row"><span style="color:#fff;">é–‹å§‹é–¾å€¤ (Noise Cut)</span><span id="t-val">20%</span></div>
      <input type="range" id="thresh" min="5" max="80" step="1" value="20" oninput="updateLine()">
    </div>

    <div class="slider-row">
      <div class="label-row"><span>æ„Ÿåº¦ (Sensitivity)</span><span id="s-val">1.0</span></div>
      <input type="range" id="sens" min="0.1" max="5.0" step="0.1" value="1.0">
    </div>
    
    <div class="slider-row">
      <div class="label-row"><span>ä½™éŸ» (Decay)</span><span id="d-val">0.95</span></div>
      <input type="range" id="decay" min="0.80" max="0.99" step="0.01" value="0.95">
    </div>
  </div>
</div>

<script>
  const video = document.getElementById('v');
  
  // â–¼â–¼â–¼ ã‚¿ãƒƒãƒ—æ™‚ã¯ã€Œå†ç”Ÿã€ã‹ã¤ã€Œé€Ÿåº¦1ã€ã«ã™ã‚‹ï¼ˆã“ã‚Œã§å†ç”Ÿãƒœã‚¿ãƒ³ãŒæ¶ˆãˆã‚‹ï¼‰ â–¼â–¼â–¼
  function forcePlay() {
    video.play();
    video.playbackRate = 1.0;
  }

  function toggleFullScreen() {
    const doc = document.documentElement;
    if (!document.fullscreenElement && !document.webkitFullscreenElement) {
      if(doc.requestFullscreen) doc.requestFullscreen();
      else if(doc.webkitRequestFullscreen) doc.webkitRequestFullscreen();
    } else {
      if(document.exitFullscreen) document.exitFullscreen();
      else if(document.webkitExitFullscreen) document.webkitExitFullscreen();
    }
  }

  const SERVICE_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
  const CHARACTERISTIC_UUID = "beb5483e-36e1-4688-b7f5-ea07361b26a8";
  const btnConnect = document.getElementById('ble-connect');
  let bluetoothDevice;

  async function connectBLE() {
    try {
      btnConnect.innerText = "ğŸ”...";
      bluetoothDevice = await navigator.bluetooth.requestDevice({
        filters: [{ name: 'M5-AV-Controller' }],
        optionalServices: [SERVICE_UUID]
      });
      const server = await bluetoothDevice.gatt.connect();
      const service = await server.getPrimaryService(SERVICE_UUID);
      const characteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);
      await characteristic.startNotifications();
      characteristic.addEventListener('characteristicvaluechanged', handleData);
      btnConnect.innerText = "âœ… OK";
      btnConnect.classList.add('connected-btn');
      toggleFullScreen();
      
      // æ¥ç¶šæ™‚ã«ä¸€åº¦å¼·åˆ¶å†ç”Ÿã—ã¦ã€ãƒ–ãƒ©ã‚¦ã‚¶ã«ã€Œå†ç”Ÿä¸­ã€ã¨èªè­˜ã•ã›ã‚‹
      video.play().catch(e => console.log("User must interact first"));

      bluetoothDevice.addEventListener('gattserverdisconnected', () => {
        btnConnect.innerText = "âŒ åˆ‡æ–­"; btnConnect.classList.remove('connected-btn');
      });
    } catch (e) { console.log(e); btnConnect.innerText = "å¤±æ•—"; }
  }

  const bar = document.getElementById('bar');
  const threshRange = document.getElementById('thresh');
  const sensRange = document.getElementById('sens');
  const decayRange = document.getElementById('decay');
  
  function updateLine() {
    document.getElementById('threshold-line').style.left = threshRange.value + "%";
    document.getElementById('t-val').innerText = threshRange.value + "%";
  }
  updateLine();

  let smoothVal = 0;
  let isMoving = false; // ã€Œå‹•ã„ã¦ã„ã‚‹ã€åˆ¤å®šãƒ•ãƒ©ã‚°

  function handleData(event) {
    const value = new TextDecoder().decode(event.target.value);
    let motion = parseFloat(value);
    if(motion < 0.05) motion = 0;

    const decay = parseFloat(decayRange.value);
    const sens = parseFloat(sensRange.value);
    smoothVal = (smoothVal * decay) + (motion * (1.0 - decay) * sens * 10);
    
    let displayVal = Math.min(smoothVal * 20, 100);
    bar.style.width = displayVal + "%";
    document.getElementById('s-val').innerText = sens;
    document.getElementById('d-val').innerText = decay;

    applyControl(displayVal);
  }

  // â–¼â–¼â–¼ ã“ã“ãŒã€Œæ™‚æ­¢ã‚ã€ã®ãƒ­ã‚¸ãƒƒã‚¯ â–¼â–¼â–¼
  function applyControl(val) {
    const mode = document.getElementById('mode').value;
    const onThreshold = parseFloat(threshRange.value);
    const offThreshold = onThreshold * 0.5;

    // ã€Œåœæ­¢ï¼é€Ÿåº¦0ã€ã€Œå†ç”Ÿï¼é€Ÿåº¦1.0ã€ã«ã™ã‚‹
    // video.pause() ã¯çµ¶å¯¾ã«ä½¿ã‚ãªã„ï¼

    if (mode === 'motion') {
      if (!isMoving) {
        if (val > onThreshold) {
          // å‹•ã‹ã—å§‹ã‚ï¼šé€Ÿåº¦ã‚’1.0ã«æˆ»ã™
          if(video.paused) video.play(); // å¿µã®ç‚º
          video.playbackRate = 1.0;
          isMoving = true;
        } else {
          // åœæ­¢ä¸­ï¼šé€Ÿåº¦ã‚’0ã«ã™ã‚‹
          video.playbackRate = 0;
        }
      } else {
        if (val < offThreshold) {
          // æ­¢ã¾ã‚‹æ™‚ï¼šé€Ÿåº¦ã‚’0ã«ã™ã‚‹
          video.playbackRate = 0;
          isMoving = false;
        } else {
          // å‹•ã„ã¦ã„ã‚‹æœ€ä¸­ï¼šé€Ÿåº¦1.0ç¶­æŒ
          if(video.playbackRate === 0) video.playbackRate = 1.0;
        }
      }
    } 
    else if (mode === 'reverse') {
      // ãƒªãƒãƒ¼ã‚¹ãƒ¢ãƒ¼ãƒ‰
      if (!isMoving) { // å†ç”Ÿä¸­çŠ¶æ…‹
        if (val < offThreshold) { // ã¾ã å‹•ã„ã¦ãªã„
           if(video.paused) video.play();
           video.playbackRate = 1.0;
           isMoving = true; // å¤‰æ•°åã¯isMovingã ãŒå®Ÿæ…‹ã¯isActiveçš„ãªæ„å‘³
        }
      } else {
        if (val > onThreshold) { // å‹•ã„ãŸï¼æ­¢ã¾ã‚Œï¼
           video.playbackRate = 0;
           isMoving = false;
        }
      }
    }
  }

  document.getElementById('file-input').addEventListener('change', function(e){
    if(e.target.files[0]) {
      video.src = URL.createObjectURL(e.target.files[0]);
      // ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ç›´å¾Œã‚‚å¼·åˆ¶å†ç”Ÿã—ã¦ã™ãé€Ÿåº¦0ã«ã™ã‚‹ï¼ˆã‚¢ã‚¤ã‚³ãƒ³å‡ºã•ãªã„ãŸã‚ï¼‰
      video.play().then(() => {
        video.playbackRate = 0; 
      });
    }
  });
  function skip(sec) { if(video.src) video.currentTime += sec; }
</script>
</body>
</html>
