<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>M5 BLE Player Full</title>
<style>
  /* ãƒªã‚»ãƒƒãƒˆ & åŸºæœ¬è¨­å®š */
  * { box-sizing: border-box; touch-action: manipulation; } /* ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—æ‹¡å¤§é˜²æ­¢ */
  
  body {
    background-color: #000;
    color: #eee;
    font-family: sans-serif;
    margin: 0;
    padding: 0;
    /* dvh: ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼ã®æœ‰ç„¡ã«é–¢ã‚ã‚‰ãšã€è¡¨ç¤ºé ˜åŸŸãã£ã¡ã‚Š100%ã«ã™ã‚‹é­”æ³•ã®å˜ä½ */
    height: 100dvh; 
    width: 100vw;
    overflow: hidden; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç¦æ­¢ */
    display: flex;
    flex-direction: column;
  }

  /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ */
  #container {
    flex: 1; /* ç”»é¢ã„ã£ã±ã„ã‚’ä½¿ã† */
    display: flex;
    flex-direction: column;
    padding: 2vw; /* ç”»é¢å¹…ã®2%ã®ä½™ç™½ */
    gap: 1vh;     /* è¦ç´ é–“éš”ã¯ç”»é¢é«˜ã•ã®1% */
  }

  /* 1. ä¸Šéƒ¨ã‚¨ãƒªã‚¢ï¼ˆæ¥ç¶šãƒœã‚¿ãƒ³ & ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠï¼‰ */
  #top-area {
    flex: 0 0 auto; /* é«˜ã•ã¯ä¸­èº«ãªã‚Š */
    display: flex;
    gap: 2vw;
  }

  #ble-connect {
    flex: 1;
    background: #ff5722;
    color: white;
    padding: 1.5vh 0; /* é«˜ã•ã¯ç”»é¢æ¯”ç‡ã§ */
    border-radius: 8px;
    font-weight: bold;
    text-align: center;
    font-size: 4vw; /* æ–‡å­—ã‚µã‚¤ã‚ºã‚‚ç”»é¢å¹…é€£å‹• */
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
  }
  .connected-btn { background: #4caf50 !important; pointer-events: none; }

  .btn-file {
    flex: 1;
    background: #007bff;
    color: white;
    padding: 1.5vh 0;
    border-radius: 8px;
    font-weight: bold;
    text-align: center;
    font-size: 3.5vw;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
  }
  input[type="file"] { display: none; }

  /* 2. å‹•ç”»ã‚¨ãƒªã‚¢ï¼ˆæ®‹ã‚Šã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’å…¨éƒ¨ä½¿ã†ï¼‰ */
  #video-area {
    flex: 1 1 auto; /* ä¼¸ã³ç¸®ã¿ã™ã‚‹ */
    background: #111;
    border: 1px solid #333;
    border-radius: 8px;
    position: relative;
    overflow: hidden;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 0; /* Flexboxã®å­è¦ç´ ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã•ã›ãªã„ãŸã‚ã®å¿…é ˆè¨­å®š */
  }
  video {
    width: 100%;
    height: 100%;
    object-fit: contain; /* ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ç¶­æŒ */
  }

  /* 3. æ“ä½œã‚¨ãƒªã‚¢ï¼ˆä¸‹éƒ¨ã«å›ºå®šçš„ãªé«˜ã•ï¼‰ */
  #controls {
    flex: 0 0 auto; /* é«˜ã•ã¯ä¸­èº«ãªã‚Šï¼ˆä¼¸ã³ãªã„ï¼‰ */
    background: #1a1a1a;
    border-radius: 12px;
    padding: 2vh 2vw;
    display: flex;
    flex-direction: column;
    gap: 1.5vh;
  }

  /* ã‚¹ã‚­ãƒƒãƒ—ãƒœã‚¿ãƒ³ç¾¤ */
  .skip-grid {
    display: grid;
    grid-template-columns: repeat(6, 1fr); /* 6å€‹æ¨ªä¸¦ã³ */
    gap: 1vw;
  }
  .btn-skip {
    background: #333; color: #fff;
    border: 1px solid #555; border-radius: 4px;
    padding: 1vh 0;
    font-size: 3vw;
    cursor: pointer;
  }
  .btn-skip:active { background: #555; }

  /* ãƒ¢ãƒ¼ãƒ‰é¸æŠ */
  select {
    width: 100%;
    padding: 1vh;
    background: #333; color: white; border: none; border-radius: 5px;
    font-size: 4vw;
    height: 5vh;
  }

  /* ãƒ¡ãƒ¼ã‚¿ãƒ¼ */
  .bar-bg {
    width: 100%; height: 1.5vh;
    background: #333; border-radius: 1vh;
    overflow: hidden;
  }
  #bar { height: 100%; width: 0%; background: linear-gradient(90deg, #0f0, #ff0, #f00); transition: width 0.1s; }

  /* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚¨ãƒªã‚¢ */
  .sliders {
    display: flex; gap: 2vw;
  }
  .slider-group { flex: 1; }
  .row { display: flex; justify-content: space-between; font-size: 3vw; color: #aaa; margin-bottom: 0.5vh;}
  
  input[type="range"] {
    width: 100%;
    height: 3vh; /* ã‚¿ãƒƒãƒã—ã‚„ã™ã„å¤ªã• */
    margin: 0;
  }

</style>
</head>
<body>

<div id="container">
  <div id="top-area">
    <div id="ble-connect" onclick="connectBLE()">ğŸ“¡ CONNECT</div>
    <label class="btn-file">ğŸ“‚ å‹•ç”»é¸æŠ<input type="file" id="file-input" accept="video/*"></label>
  </div>

  <div id="video-area">
    <video id="v" playsinline webkit-playsinline controls loop></video>
  </div>

  <div id="controls">
    <div class="skip-grid">
      <button class="btn-skip" onclick="skip(-300)">-5m</button>
      <button class="btn-skip" onclick="skip(-60)">-1m</button>
      <button class="btn-skip" onclick="skip(-10)">-10s</button>
      <button class="btn-skip" onclick="skip(10)">+10s</button>
      <button class="btn-skip" onclick="skip(60)">+1m</button>
      <button class="btn-skip" onclick="skip(300)">+5m</button>
    </div>

    <select id="mode">
      <option value="motion">ğŸƒ Motion Play (å‹•ãã¨å†ç”Ÿ)</option>
      <option value="reverse">ğŸ§˜ Reverse Gate (æ­¢ã¾ã‚‹ã¨å†ç”Ÿ)</option>
      <option value="none">ğŸ›‘ Monitor Only</option>
    </select>

    <div class="bar-bg"><div id="bar"></div></div>

    <div class="sliders">
      <div class="slider-group">
        <div class="row"><span>æ„Ÿåº¦</span><span id="s-val">2.0</span></div>
        <input type="range" id="sens" min="0.5" max="5.0" step="0.1" value="2.0">
      </div>
      <div class="slider-group">
        <div class="row"><span>ä½™éŸ»</span><span id="d-val">0.9</span></div>
        <input type="range" id="decay" min="0.5" max="0.99" step="0.01" value="0.9">
      </div>
    </div>
  </div>
</div>

<script>
  // BLEè¨­å®š
  const SERVICE_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
  const CHARACTERISTIC_UUID = "beb5483e-36e1-4688-b7f5-ea07361b26a8";
  
  let bluetoothDevice;
  let characteristic;
  const btnConnect = document.getElementById('ble-connect');
  
  // â–¼ å…¨ç”»é¢åŒ–ãƒ­ã‚¸ãƒƒã‚¯ â–¼
  function goFullScreen() {
    const doc = document.documentElement;
    if (doc.requestFullscreen) { doc.requestFullscreen(); }
    else if (doc.webkitRequestFullscreen) { doc.webkitRequestFullscreen(); } // Chrome/Safari old
  }

  async function connectBLE() {
    // 1. ã¾ãšå…¨ç”»é¢åŒ–ã‚’è©¦ã¿ã‚‹ (ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç›´å¾Œãªã‚‰æˆåŠŸç‡é«˜ã„)
    goFullScreen();

    try {
      btnConnect.innerText = "ğŸ”...";
      
      // 2. Bluetoothãƒ‡ãƒã‚¤ã‚¹ã‚’æ¢ã™
      bluetoothDevice = await navigator.bluetooth.requestDevice({
        filters: [{ name: 'M5-AV-Controller' }],
        optionalServices: [SERVICE_UUID]
      });

      const server = await bluetoothDevice.gatt.connect();
      const service = await server.getPrimaryService(SERVICE_UUID);
      characteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);

      await characteristic.startNotifications();
      characteristic.addEventListener('characteristicvaluechanged', handleData);
      
      btnConnect.innerText = "âœ… OK";
      btnConnect.classList.add('connected-btn');
      
      bluetoothDevice.addEventListener('gattserverdisconnected', () => {
        btnConnect.innerText = "âŒ åˆ‡æ–­";
        btnConnect.classList.remove('connected-btn');
      });

    } catch (error) {
      console.log(error);
      btnConnect.innerText = "å¤±æ•—/å–æ¶ˆ";
      // å¤±æ•—ã—ã¦ã‚‚å†æŒ‘æˆ¦ã§ãã‚‹ã‚ˆã†ã«æˆ»ã™
      setTimeout(() => { btnConnect.innerText = "ğŸ“¡ CONNECT"; }, 2000);
    }
  }

  // --- ä»¥ä¸‹ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ¶å¾¡ãƒ­ã‚¸ãƒƒã‚¯ (å¤‰æ›´ãªã—) ---
  const video = document.getElementById('v');
  const bar = document.getElementById('bar');
  const modeSel = document.getElementById('mode');
  const sensRange = document.getElementById('sens');
  const decayRange = document.getElementById('decay');
  
  let smoothVal = 0;

  function handleData(event) {
    const value = new TextDecoder().decode(event.target.value);
    const rawG = parseFloat(value);
    let motion = Math.abs(rawG - 1.0);
    if(motion < 0.15) motion = 0; 

    const decay = parseFloat(decayRange.value);
    const sens = parseFloat(sensRange.value);
    smoothVal = (smoothVal * decay) + (motion * (1.0 - decay) * sens * 10);

    let per = Math.min(smoothVal * 20, 100);
    bar.style.width = per + "%";

    controlVideo(smoothVal);
    
    document.getElementById('s-val').innerText = sens;
    document.getElementById('d-val').innerText = decay;
  }
  
  function controlVideo(val) {
    const mode = modeSel.value;
    const threshold = 0.5; 
    if (mode === 'motion') {
      if (val > threshold) { if(video.paused) video.play(); } 
      else { if(!video.paused) video.pause(); }
    } else if (mode === 'reverse') {
      if (val < threshold) { if(video.paused) video.play(); } 
      else { if(!video.paused) video.pause(); }
    }
  }

  document.getElementById('file-input').addEventListener('change', function(e){
    if(e.target.files[0]) video.src = URL.createObjectURL(e.target.files[0]);
  });
  function skip(sec) { if(video.src) video.currentTime += sec; }
</script>
</body>
</html>
